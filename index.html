<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda 츼lbum de Formatura</title>
 먝
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estilos b치sicos com Tailwind e CSS */
    body {
      font-family: 'Inter', sans-serif;
      background-image: url('formatura.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .container { max-width: 900px; }
    .nav-item:hover { background-color: #2563eb; color: white; }
    /* Estilos do Formul치rio */
    .form-card { max-width: 500px; }
    input[type="text"], input[type="email"], input[type="tel"], textarea, select {
      border: 1px solid #d1d5db;
      padding: 10px;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      margin-top: 4px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <header class="bg-blue-600 text-white shadow-lg">
    <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="text-xl font-bold">Agenda de Visitas</div>
      <div id="nav-links">
        <button onclick="navigate('index')" class="nav-item px-4 py-2 rounded-lg transition duration-200 bg-blue-700">Agendar Visita</button>
       먝
        <button onclick="checkPassword()" class="nav-item px-4 py-2 rounded-lg transition duration-200">Minha Agenda</button>
       먝
      </div>
    </nav>
  </header>

  <main id="app-content" class="container mx-auto p-4 md:p-8 flex-grow flex items-center justify-center">
    <div class="text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
      <p class="mt-4 text-gray-600">Carregando sistema...</p>
    </div>
  </main>
 먝
  <footer class="bg-gray-200 text-center p-4 mt-8 text-sm text-gray-600">
    <p>&copy; 2025 Evanio Martins. Todos os direitos reservados. | Status: <span id="status-display" class="font-mono text-xs">Aguardando...</span></p>
  </footer>

  <script type="module">
    // =================================================================
    // 1. CONFIGURA칂칏ES DO FIREBASE (REALTIME DATABASE - RTDB)
    // =================================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    // Importa칞칫es MUDADAS para Realtime Database
    import { getDatabase, ref, onValue, set, remove, child, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Sua configura칞칚o real
    const firebaseConfig = {
      apiKey: "AIzaSyANz1gbAi3PIGwS1-RzOIXF6SUZvS2U0mU",
      authDomain: "agenda-album-de-formatura.firebaseapp.com",
      // CHAVE RTDB obrigat칩ria e confirmada pelo seu console
      databaseURL: "https://agenda-album-de-formatura-default-rtdb.firebaseio.com",
      projectId: "agenda-album-de-formatura",
      storageBucket: "agenda-album-de-formatura.firebasestorage.app",
      messagingSenderId: "29604114447",
      appId: "1:29604114447:web:bac79aba4c4aa945c8737a"
    };
   먝
    // Inst칙ncias do Firebase
    let app;
    let db; // Inst칙ncia do RTDB
    let agendamentos = {}; // Objeto para armazenar dados do RTDB
    let currentView = 'index';
    let errorMessage = '';
    let currentSessionId = null;

    // Constantes da Aplica칞칚o
    const SEU_NOME = 'Evanio Martins';
    // Caminho da cole칞칚o no RTDB. DEVE CORRESPONDER  REGRA DE SEGURAN칂A!
    const COLLECTION_PATH = 'agendamentos';
   먝
    // 游댐 DATAS FIXAS ATUALIZADAS: 16/12/2025 a 19/12/2025
    const DATAS_FIXAS = [
      '2025-12-16', // Ter칞a-feira
      '2025-12-17', // Quarta-feira
      '2025-12-18', // Quinta-feira
      '2025-12-19', // Sexta-feira
    ];
   먝
    // 游댐 INTERVALOS DE TEMPO ATUALIZADOS: Fim 맙 20:30h
    const HORA_MAX_Geral = 20; // 20:00h
    const MINUTO_MAX_Geral = 30; // O 칰ltimo hor치rio 칠 20:30h
   먝
    const ADMIN_PASSWORD = '2025';

    // Vari치vel auxiliar para navega칞칚o (j치 que o RTDB n칚o tem onAuthStateChanged)
    let isDBReady = false;

    window.checkPassword = () => {
      const enteredPassword = window.prompt("Por favor, digite a senha de administrador para acessar a agenda:");
      if (enteredPassword === ADMIN_PASSWORD) {
        navigate('agenda');
      } else if (enteredPassword !== null) {
        alert("Senha incorreta. Acesso negado.");
      }
    };
   먝
    // Fun칞칚o para formata칞칚o de data e hora em Portugu칡s
    const formatDateTime = (date, includeTime = true, includeYear = true) => {
      const options = {
        weekday: 'long',
        day: '2-digit',
        month: '2-digit',
        year: includeYear ? 'numeric' : undefined,
        hour: includeTime ? '2-digit' : undefined,
        minute: includeTime ? '2-digit' : undefined,
        hour12: false
      };
      // Tratamento para TimeStamp de RTDB (que n칚o 칠 nativo)
      const dateObj = (date instanceof Date) ? date : new Date(date);
     먝
      return dateObj.toLocaleString('pt-BR', options)
        .replace(/\b(\w)/g, l => l.toUpperCase())
        .replace(',', ' -');
    };

    // =================================================================
    // 2. INICIALIZA칂츾O DO RTDB
    // =================================================================

    function initFirebase(config) {
      try {
        app = initializeApp(config);
        db = getDatabase(app);
        isDBReady = true;

        // N칚o precisamos de login an칪nimo. Apenas for칞amos a leitura e o uso do RTDB
        fetchAgendamentosRTDB();
       먝
        document.getElementById('status-display').textContent = 'Conectado ao RTDB';
        navigate('index'); // Carrega o formul치rio
       먝
      } catch (error) {
        console.error("Erro fatal na inicializa칞칚o do Firebase:", error);
        document.getElementById('status-display').textContent = 'Erro de Conex칚o';
        renderErro('Erro fatal: N칚o foi poss칤vel conectar ao Realtime Database. Verifique sua `databaseURL`.');
      }
    }

    // =================================================================
    // 3. OPERA칂칏ES RTDB (CRUD)
    // =================================================================
   먝
    function fetchAgendamentosRTDB() {
      if (!isDBReady) return;

      const agendamentosRef = ref(db, COLLECTION_PATH);
     먝
      // onValue: Escuta em tempo real no Realtime Database
      onValue(agendamentosRef, (snapshot) => {
        agendamentos = snapshot.val() || {}; // RTDB retorna um objeto
       먝
        // Mapeia os dados do RTDB para um formato mais amig치vel para a UI (lista plana)
        const agendamentosFormatados = [];
        for (const dataKey in agendamentos) {
          for (const horarioKey in agendamentos[dataKey]) {
            const agendamento = agendamentos[dataKey][horarioKey];
            // O ID do documento 칠 a combina칞칚o de data e hor치rio (ex: 2025-10-31/0900)
            agendamento.id = `${dataKey}/${horarioKey}`;
            // data_hora 칠 o objeto Date para compara칞칚o
           먝
            // 游댐 CORRE칂츾O: Usa o valor de 'horario' (HH:MM) para construir a data.
            agendamento.data_hora = new Date(agendamento.data + 'T' + agendamento.horario + ':00');
            agendamentosFormatados.push(agendamento);
          }
        }
        // Ordena por data_hora (do mais antigo para o mais novo)
        agendamentosFormatados.sort((a, b) => a.data_hora - b.data_hora);
       먝
        agendamentos = agendamentosFormatados;
        render();
       먝
      }, (error) => {
        console.error("Erro ao buscar agendamentos RTDB:", error);
        renderErro("Erro ao buscar agendamentos em tempo real. Verifique as Regras de Seguran칞a do Realtime Database.");
      });
    }

    async function salvarAgendamento(event) {
      event.preventDefault();
     먝
      if (!isDBReady) {
        renderErro("Erro ao salvar: A conex칚o com o banco de dados n칚o est치 pronta.");
        return;
      }

      const form = event.target;
      const dataHoraStr = form.data_hora.value;
     먝
      if (!dataHoraStr) {
        renderErro("Por favor, selecione uma data e hora.");
        return;
      }

      const dataHoraObj = new Date(dataHoraStr);
      const dataKey = dataHoraObj.toISOString().slice(0, 10); // YYYY-MM-DD
      // O hor치rio 칠 formatado para HHMM para ser usado como chave 칰nica no RTDB
      const horarioKey = dataHoraObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false }).replace(':', '');

      // 1. Verifica se o hor치rio j치 est치 reservado
      const isReserved = agendamentos.some(a => a.data_hora.getTime() === dataHoraObj.getTime());
      if (isReserved) {
        renderErro("Este hor치rio foi reservado por outro formando. Por favor, escolha outro.");
        return;
      }

      const novoAgendamento = {
        nome_formando: form.nome_formando.value.trim(),
        endereco: form.endereco.value.trim(),
        data: dataKey,
        // Salva o hor치rio em HH:MM para facilitar a leitura futura
        horario: dataHoraObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false }),
        telefone: form.telefone.value.trim() || null,
        criado_em: new Date().toISOString(),
        // Como n칚o tem autentica칞칚o, usamos o hor치rio para tentar simular um ID de usu치rio 칰nico de sess칚o
        sessionId: new Date().getTime().toString()
      };

      try {
        // Caminho no RTDB: agendamentos/YYYY-MM-DD/HHMM
        const agendamentoRef = ref(db, `${COLLECTION_PATH}/${dataKey}/${horarioKey}`);
       먝
        // Set() sobrescreve se existir, garantindo a atomicidade
        await set(agendamentoRef, novoAgendamento);
       먝
        navigate('sucesso');
       먝
      } catch (e) {
        console.error("Erro ao adicionar documento RTDB: ", e);
        renderErro(`Erro ao salvar no banco de dados: ${e.message}. Verifique as Regras de Seguran칞a.`);
      }
    }

    async function excluirAgendamento(id) {
      if (!isDBReady) {
        renderErro("Erro ao excluir: A conex칚o com o banco de dados n칚o est치 pronta.");
        return;
      }

      if (!window.confirm("Tem certeza que deseja excluir este agendamento?")) {
        return;
      }

      try {
        // ID do RTDB 칠 data/horario (ex: 2025-10-31/0900)
        const docRef = ref(db, `${COLLECTION_PATH}/${id}`);
        await remove(docRef);
       먝
        // onValue se encarrega de atualizar a lista
      } catch (e) {
        console.error("Erro ao excluir documento RTDB: ", e);
        renderErro(`Erro ao excluir o agendamento: ${e.message}`);
      }
    }


    // =================================================================
    // 4. L칍GICA DE AGENDAMENTO E RENDERIZA칂츾O
    // =================================================================
   먝
    function obterHorariosDisponiveis() {
      const horariosDisponiveis = [];
     먝
      // C칍PIA E AJUSTE DA HORA ATUAL PARA COMPARA칂츾O (REMOVER SEGUNDOS)
      const agora = new Date();
      agora.setSeconds(0, 0);

      // Mapeia hor치rios j치 reservados
      const horariosReservados = agendamentos.map(a => a.data_hora.getTime());

      for (const dataStr of DATAS_FIXAS) {
        const [ano, mes, dia] = dataStr.split('-').map(Number);
       먝
        // 游댐 HORA DE IN칈CIO FIXA EM 09:00H PARA TODAS AS DATAS
        const HORA_INICIO = 9;
        const HORA_FIM = HORA_MAX_Geral; // 20h
        const HORA_FIM_COMPLETA = HORA_FIM + (MINUTO_MAX_Geral / 60); // 20.5

        for (let hora = HORA_INICIO; hora <= HORA_FIM; hora++) {
          // GERA SLOTS DE 30 EM 30 MINUTOS (0 e 30)
          for (const minuto of [0, 30]) {
           먝
            // 游댐 Garante que o 칰ltimo slot seja 20:30h (ou o limite definido)
                        if (hora + (minuto / 60) > HORA_FIM_COMPLETA) {
                            continue;
                        }

            const dataHoraCandidata = new Date(ano, mes - 1, dia, hora, minuto, 0, 0);
            const timestampCandidato = dataHoraCandidata.getTime();

            // Checa se o hor치rio j치 passou (para HOJE)
            if (timestampCandidato > agora.getTime()) {
              if (!horariosReservados.includes(timestampCandidato)) {
               먝
                const nomeDiaPt = formatDateTime(dataHoraCandidata, false, false);
                const horaMinuto = dataHoraCandidata.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
               먝
                horariosDisponiveis.push({
                  'display': `${nomeDiaPt} - ${dataHoraCandidata.toLocaleDateString('pt-BR')} 맙 ${horaMinuto}`,
                  'value': dataHoraCandidata.toISOString() // Formato ISO para envio
                });
              }
            }
          }
        }
      }

      return horariosDisponiveis;
    }

    window.navigate = (view, error = '') => {
      currentView = view;
      errorMessage = error;
      render();
    }

    function renderIndex() {
      const horarios = obterHorariosDisponiveis();
     먝
      const optionsHtml = horarios.length > 0
        ? horarios.map(h => `<option value="${h.value}">${h.display}</option>`).join('')
        : '<option value="" disabled>-- N칚o h치 hor치rios dispon칤veis --</option>';

      const content = `
        <div class="bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl form-card w-full max-w-lg">
          <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Agendamento de Visita</h1>
          <p class="text-gray-600 mb-8">Ol치! Para que possamos apresentar as fotos, por favor, preencha os dados e escolha um hor치rio dispon칤vel na lista abaixo.</p>

          <h2 class="text-2xl font-semibold text-blue-600 mb-6 border-b pb-2">Agende seu Hor치rio</h2>

          <form id="agendamento-form" class="space-y-6">
            <div>
