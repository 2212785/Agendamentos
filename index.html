<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agenda Álbum de Formatura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: url('formatura.jpg'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed;
        }
       .container { max-width: 900px; }
       .nav-item:hover { background-color: #2563eb; color: white; }
        input[type="text"], input[type="tel"], textarea, select {
            border: 1px solid #d1d5db;
            padding: 12px;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 4px;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-blue-600 text-white shadow-lg">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold">Agenda de Visitas</div>
            <div id="nav-links">
                <button onclick="navigate('index')" class="nav-item px-4 py-2 rounded-lg transition duration-200 bg-blue-700">Agendar</button>
                <button onclick="checkPassword()" class="nav-item px-4 py-2 rounded-lg transition duration-200">Minha Agenda</button>
            </div>
        </nav>
    </header>

    <main id="app-content" class="container mx-auto p-4 md:p-8 flex-grow flex items-center justify-center"> 
        <div class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Carregando horários disponíveis...</p>
        </div>
    </main>
    
    <footer class="bg-gray-200 text-center p-4 mt-8 text-sm text-gray-600">
        <p>&copy; 2026 Evanio Martins. Todos os direitos reservados. | Status: <span id="status-display" class="font-mono text-xs text-green-600">Agendamentos Abertos</span></p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyANz1gbAi3PIGwS1-RzOIXF6SUZvS2U0mU", 
            authDomain: "agenda-album-de-formatura.firebaseapp.com",
            databaseURL: "https://agenda-album-de-formatura-default-rtdb.firebaseio.com", 
            projectId: "agenda-album-de-formatura",
            storageBucket: "agenda-album-de-formatura.firebasestorage.app",
            messagingSenderId: "29604114447",
            appId: "1:29604114447:web:bac79aba4c4aa945c8737a"
        };
        
        let app, db;
        let agendamentos =; 
        let currentView = 'index';
        let isDBReady = false;

        const ADMIN_PASSWORD = '2025';
        const COLLECTION_PATH = 'agendamentos'; 

        // CONFIGURAÇÃO DE DATAS: Hoje (03/02) até Domingo (08/02)
        const DATAS_FIXAS = [
            '2026-02-03', '2026-02-04', '2026-02-05', 
            '2026-02-06', '2026-02-07', '2026-02-08'
        ];

        window.checkPassword = () => {
            const enteredPassword = window.prompt("Digite a senha de administrador:");
            if (enteredPassword === ADMIN_PASSWORD) navigate('agenda');
            else if (enteredPassword!== null) alert("Senha incorreta.");
        };
        
        const formatDateTime = (date) => {
            const dateObj = (date instanceof Date)? date : new Date(date);
            const weekday = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
            const dayMonth = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            const time = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
            return `${weekday.charAt(0).toUpperCase() + weekday.slice(1)} ${dayMonth} às ${time}`;
        };

        function initFirebase(config) {
            try {
                app = initializeApp(config);
                db = getDatabase(app); 
                isDBReady = true;
                fetchAgendamentosRTDB(); 
                navigate('index'); 
            } catch (error) {
                console.error("Erro Firebase:", error);
            }
        }

        function fetchAgendamentosRTDB() {
            if (!isDBReady) return;
            const agendamentosRef = ref(db, COLLECTION_PATH);
            onValue(agendamentosRef, (snapshot) => {
                const data = snapshot.val() |

| {};
                const formatados =;
                for (const dateKey in data) {
                    for (const hourKey in data[dateKey]) {
                        const item = data[dateKey][hourKey];
                        item.id = `${dateKey}/${hourKey}`;
                        item.data_hora = new Date(item.data + 'T' + item.horario + ':00');
                        formatados.push(item);
                    }
                }
                formatados.sort((a, b) => a.data_hora - b.data_hora);
                agendamentos = formatados;
                render();
            });
        }

        async function salvarAgendamento(event) {
            event.preventDefault();
            if (!isDBReady) return;

            const form = event.target;
            const dataHoraObj = new Date(form.data_hora.value);
            const dataKey = dataHoraObj.toISOString().slice(0, 10);
            const horarioKey = dataHoraObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }).replace(':', '');

            const novoAgendamento = {
                nome_formando: form.nome_formando.value.trim(),
                endereco: form.endereco.value.trim(),
                data: dataKey,
                horario: dataHoraObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                telefone: form.telefone.value.trim() |

| null,
                criado_em: new Date().toISOString()
            };

            try {
                await set(ref(db, `${COLLECTION_PATH}/${dataKey}/${horarioKey}`), novoAgendamento);
                navigate('sucesso');
            } catch (e) {
                alert("Erro ao salvar.");
            }
        }

        window.excluirAgendamento = async (id) => {
            if (window.confirm("Excluir este agendamento?")) {
                await remove(ref(db, `${COLLECTION_PATH}/${id}`));
            }
        };

        function obterHorariosDisponiveis() {
            const disponiveis =;
            const agora = new Date();
            const reservados = agendamentos.map(a => a.data_hora.getTime());

            for (const dataStr of DATAS_FIXAS) {
                const [ano, mes, dia] = dataStr.split('-').map(Number);
                let hInicio = 9;
                let hFim = 20;

                // Regras Específicas
                if (dataStr === '2026-02-03') { // Hoje
                    hInicio = 18;
                } else {
                    const d = new Date(ano, mes - 1, dia);
                    if (d.getDay() === 0 |

| d.getDay() === 6) { // Sáb ou Dom
                        hFim = 15;
                    }
                }

                for (let h = hInicio; h <= hFim; h++) {
                    const candidata = new Date(ano, mes - 1, dia, h, 0, 0);
                    if (candidata > agora &&!reservados.includes(candidata.getTime())) {
                        disponiveis.push({
                            display: formatDateTime(candidata),
                            value: candidata.toISOString()
                        });
                    }
                }
            }
            return disponiveis;
        }

        window.navigate = (view) => {
            currentView = view;
            render();
        };

        function renderIndex() {
            const horarios = obterHorariosDisponiveis();
            const options = horarios.map(h => `<option value="${h.value}">${h.display}</option>`).join('');

            document.getElementById('app-content').innerHTML = `
                <div class="bg-white bg-opacity-95 p-8 rounded-3xl shadow-2xl w-full max-w-lg border-t-8 border-blue-600"> 
                    <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Agendar Visita</h1>
                    <p class="text-gray-600 mb-8">Escolha um horário para apresentação do álbum de formatura.</p>
                    <form id="agendamento-form" class="space-y-5">
                        <input type="text" name="nome_formando" required placeholder="Nome Completo">
                        <textarea name="endereco" required placeholder="Endereço para a Visita" rows="2"></textarea>
                        <input type="tel" name="telefone" placeholder="WhatsApp (Opcional)">
                        <select name="data_hora" required>
                            <option value="" disabled selected>-- Selecione o Horário --</option>
                            ${options |

| '<option disabled>Nenhum horário disponível</option>'}
                        </select>
                        <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition shadow-lg">Confirmar Agendamento</button>
                    </form>
                </div>`;
            document.getElementById('agendamento-form').addEventListener('submit', salvarAgendamento);
        }

        function renderAgenda() {
            const rowHtml = agendamentos.filter(a => a.data_hora >= new Date()).map(a => `
                <tr class="border-b hover:bg-gray-50 text-xs sm:text-sm">
                    <td class="p-3 font-medium">${formatDateTime(a.data_hora)}</td>
                    <td class="p-3 font-bold">${a.nome_formando}</td>
                    <td class="p-3">${a.endereco}</td>
                    <td class="p-3 text-center"><button onclick="excluirAgendamento('${a.id}')" class="text-red-600 font-bold">EXCLUIR</button></td>
                </tr>`).join('');

            document.getElementById('app-content').innerHTML = `
                <div class="bg-white bg-opacity-95 p-6 rounded-3xl shadow-2xl w-full overflow-x-auto">
                    <h1 class="text-2xl font-bold mb-4 text-blue-800">Relatório de Visitas</h1>
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-blue-50 text-[10px] uppercase text-blue-900">
                            <tr><th class="p-3">Data/Hora</th><th class="p-3">Formando</th><th class="p-3">Endereço</th><th class="p-3">Ação</th></tr>
                        </thead>
                        <tbody>${rowHtml |

| '<tr><td colspan="4" class="p-4 text-center">Nenhum agendamento futuro.</td></tr>'}</tbody>
                    </table>
                    <button onclick="navigate('index')" class="mt-6 text-blue-600 font-bold flex items-center gap-2">← Voltar</button>
                </div>`;
        }

        function renderSucesso() {
            document.getElementById('app-content').innerHTML = `
                <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-sm border-t-8 border-green-500">
                    <div class="text-5xl mb-4">✅</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Sucesso!</h2>
                    <p class="text-gray-600 mb-8">Seu horário foi reservado. Em breve entraremos em contato.</p>
                    <button onclick="navigate('index')" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-bold">Voltar</button>
                </div>`;
        }

        function render() {
            if (currentView === 'agenda') renderAgenda();
            else if (currentView === 'sucesso') renderSucesso();
            else renderIndex();
        }

        initFirebase(firebaseConfig);
    </script>
</body>
</html>
