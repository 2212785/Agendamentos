<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Visita - Firestore</title>
    <!-- Carrega Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .nav-item:hover { background-color: #2563eb; color: white; }
        .container { max-width: 900px; }
        .delete-button { background-color: #ef4444; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .delete-button:hover { background-color: #dc2626; }
        input[type="text"], input[type="email"], input[type="tel"], textarea, select {
            border: 1px solid #d1d5db;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Cabeçalho -->
    <header class="bg-blue-600 text-white shadow-lg">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold">Agenda de Visitas</div>
            <div id="nav-links">
                <button onclick="navigate('index')" class="nav-item px-4 py-2 rounded-lg transition duration-200 bg-blue-700">Agendar Visita</button>
                <button onclick="navigate('agenda')" class="nav-item px-4 py-2 rounded-lg transition duration-200">Minha Agenda</button>
            </div>
        </nav>
    </header>

    <!-- Conteúdo Principal -->
    <main id="app-content" class="container mx-auto p-4 md:p-8 flex-grow">
        <!-- O conteúdo será renderizado aqui pelo JavaScript -->
        <div class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Carregando sistema...</p>
        </div>
    </main>

    <!-- Rodapé -->
    <footer class="bg-gray-200 text-center p-4 mt-8 text-sm text-gray-600">
        <p>&copy; 2025 Evanio Martins. Todos os direitos reservados. | Usuário: <span id="user-id-display" class="font-mono text-xs">Aguardando...</span></p>
        <p class="mt-2 text-xs text-red-600">Aviso: A função de envio de e-mail foi removida, pois requer um serviço de backend (como o Flask original). Para enviar e-mails, você precisará de uma API externa (ex: SendGrid, EmailJS).</p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variáveis Globais de Configuração (Fornecidas pelo ambiente Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Instâncias do Firebase
        let app;
        let auth;
        let db;
        let userId = null;
        let agendamentos = [];
        let currentView = 'index';
        let errorMessage = '';

        // Constantes da Aplicação
        const SEU_NOME = 'Evanio Martins';
        const COLLECTION_PATH = `artifacts/${appId}/public/data/agendamentos`;
        const DATAS_FIXAS = [
            '2025-10-31', // Sexta-feira
            '2025-11-01', // Sábado
            '2025-11-02', // Domingo
            '2025-11-03', // Segunda-feira
        ];
        const HORA_INICIO = 9;
        const HORA_FIM = 20; // Inclui 20:00h

        // Função para formatação de data e hora em Português
        const formatDateTime = (date, includeTime = true, includeYear = true) => {
            const options = { 
                weekday: 'long', 
                day: '2-digit', 
                month: '2-digit', 
                year: includeYear ? 'numeric' : undefined,
                hour: includeTime ? '2-digit' : undefined, 
                minute: includeTime ? '2-digit' : undefined,
                hour12: false
            };
            return new Date(date).toLocaleString('pt-BR', options)
                .replace(/\b(\w)/g, l => l.toUpperCase()) // Capitaliza dias da semana e meses
                .replace(',', ' -'); // Ajusta a separação entre dia e data
        };

        // =================================================================
        // 1. INICIALIZAÇÃO E AUTENTICAÇÃO DO FIREBASE
        // =================================================================

        function initFirebase(config) {
            if (!config) {
                console.error("Erro: Configuração do Firebase não foi fornecida.");
                renderErro("Erro fatal: As configurações do Firebase estão ausentes.");
                return;
            }

            app = initializeApp(config);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    fetchAgendamentos(); // Inicia a escuta após a autenticação
                    
                    // Garante que o usuário veja a página de agendamento após o login SÓ SE ESTIVER NA TELA DE CARREGAMENTO/ERRO INICIAL
                    if (currentView === 'index' || currentView === 'erro') {
                         navigate('index'); 
                    }
                } else {
                    // Tenta autenticar
                    try {
                        if (initialAuthToken) {
                            const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                            userId = userCredential.user.uid;
                        } else {
                            // Se o token não estiver disponível, faz o login anônimo
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                        }
                        document.getElementById('user-id-display').textContent = userId;
                    } catch (error) {
                        console.error("Erro na autenticação:", error);
                        renderErro('Não foi possível conectar ao sistema de autenticação. Tente recarregar a página.');
                    }
                }
            });
        }
        
        // =================================================================
        // 2. LÓGICA DE AGENDAMENTO (GERAÇÃO E FILTRAGEM)
        // =================================================================

        function obterHorariosDisponiveis() {
            const horariosDisponiveis = [];
            const agora = new Date();
            const horariosReservados = agendamentos.map(a => a.data_hora.toDate().getTime());

            for (const dataStr of DATAS_FIXAS) {
                const [ano, mes, dia] = dataStr.split('-').map(Number);
                
                for (let hora = HORA_INICIO; hora <= HORA_FIM; hora++) {
                    // Cria o objeto Date para a hora cheia
                    const dataHoraCandidata = new Date(ano, mes - 1, dia, hora, 0, 0, 0);
                    const timestampCandidato = dataHoraCandidata.getTime();
                    
                    // 1. Checa se o horário ainda não passou
                    if (timestampCandidato > agora.getTime()) {
                        // 2. Checa se o horário já foi reservado
                        if (!horariosReservados.includes(timestampCandidato)) {
                            
                            const nomeDiaPt = formatDateTime(dataHoraCandidata, false, false);
                            const horaMinuto = dataHoraCandidata.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
                            
                            horariosDisponiveis.push({
                                // Exemplo de formato: "Sexta-feira, 31/10/2025 às 09:00"
                                'display': `${nomeDiaPt} - ${dataHoraCandidata.toLocaleDateString('pt-BR')} às ${horaMinuto}`,
                                'value': dataHoraCandidata.toISOString() // Formato ISO para envio
                            });
                        }
                    }
                }
            }

            return horariosDisponiveis;
        }

        // =================================================================
        // 3. OPERAÇÕES FIREBASE (CRUD)
        // =================================================================

        function fetchAgendamentos() {
            if (!db || !userId) return;

            const agendamentosRef = collection(db, COLLECTION_PATH);
            const q = query(agendamentosRef, orderBy('data_hora'));

            // Escuta em tempo real (onSnapshot)
            onSnapshot(q, (snapshot) => {
                agendamentos = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Garante que a tela será renderizada após a busca inicial
                render();
            }, (error) => {
                console.error("Erro ao buscar agendamentos:", error);
                renderErro("Erro ao buscar agendamentos em tempo real.");
            });
        }

        async function salvarAgendamento(event) {
            event.preventDefault();
            
            const form = event.target;
            const dataHoraStr = form.data_hora.value;
            
            if (!dataHoraStr) {
                renderErro("Por favor, selecione uma data e hora.");
                return;
            }

            const dataHoraObj = new Date(dataHoraStr);

            // Verifica novamente se o horário está disponível antes de salvar
            const isReserved = agendamentos.some(a => a.data_hora.toDate().getTime() === dataHoraObj.getTime());
            if (isReserved) {
                renderErro("Este horário foi reservado por outro formando. Por favor, escolha outro.");
                return;
            }

            const novoAgendamento = {
                nome_formando: form.nome_formando.value.trim(),
                endereco: form.endereco.value.trim(),
                data_hora: dataHoraObj, // Salva como Timestamp
                email_cliente: form.email_cliente.value.trim(),
                telefone: form.telefone.value.trim() || null,
                criado_em: serverTimestamp(),
                userId: userId, // Identifica quem criou o agendamento
            };

            try {
                const agendamentosRef = collection(db, COLLECTION_PATH);
                await addDoc(agendamentosRef, novoAgendamento);
                navigate('sucesso');
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                renderErro(`Erro ao salvar no banco de dados: ${e.message}`);
            }
        }

        async function excluirAgendamento(id) {
            // Usamos uma modal simples no lugar de 'confirm()' (que é bloqueado)
            if (!window.confirm("Tem certeza que deseja excluir este agendamento?")) {
                 return;
            }

            try {
                const docRef = doc(db, COLLECTION_PATH, id);
                await deleteDoc(docRef);
                // A navegação para 'agenda' é automática via onSnapshot
            } catch (e) {
                console.error("Erro ao excluir documento: ", e);
                renderErro(`Erro ao excluir o agendamento: ${e.message}`);
            }
        }


        // =================================================================
        // 4. RENDERIZAÇÃO DA INTERFACE (VIEWS)
        // =================================================================

        window.navigate = (view, error = '') => {
            currentView = view;
            errorMessage = error;
            render();
        }

        function renderIndex() {
            const horarios = obterHorariosDisponiveis();
            
            const optionsHtml = horarios.length > 0
                ? horarios.map(h => `<option value="${h.value}">${h.display}</option>`).join('')
                : '<option value="" disabled>-- Não há horários disponíveis --</option>';

            const content = `
                <div class="bg-white p-8 rounded-xl shadow-2xl">
                    <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Agendamento de Visita</h1>
                    <p class="text-gray-600 mb-8">Olá! Para que possamos apresentar os álbuns de formatura, por favor, preencha os dados e escolha um horário disponível na lista abaixo.</p>

                    <h2 class="text-2xl font-semibold text-blue-600 mb-6 border-b pb-2">Agende seu Horário</h2>

                    <form id="agendamento-form" class="space-y-6">
                        <div>
                            <label for="nome_formando" class="block text-sm font-medium text-gray-700">Nome Completo do Formando(a):</label>
                            <input type="text" id="nome_formando" name="nome_formando" required placeholder="Ex: João da Silva">
                        </div>
                        
                        <div>
                            <label for="email_cliente" class="block text-sm font-medium text-gray-700">Seu E-mail (Para receber a confirmação):</label>
                            <input type="email" id="email_cliente" name="email_cliente" required placeholder="Ex: joao@email.com">
                        </div>

                        <div>
                            <label for="endereco" class="block text-sm font-medium text-gray-700">Endereço Completo para a Visita:</label>
                            <textarea id="endereco" name="endereco" required placeholder="Ex: Rua das Flores, 123, Bairro Centro" rows="2"></textarea>
                        </div>

                        <div>
                            <label for="telefone" class="block text-sm font-medium text-gray-700">Seu Telefone (Opcional):</label>
                            <input type="tel" id="telefone" name="telefone" placeholder="(DDD) 99999-9999">
                        </div>

                        <div>
                            <label for="data_hora" class="block text-sm font-medium text-gray-700">Escolha a Data e Hora (Horários de ${HORA_INICIO}:00h às ${HORA_FIM}:00h):</label>
                            <select id="data_hora" name="data_hora" required class="${horarios.length === 0 ? 'bg-gray-100 text-gray-500' : ''}" ${horarios.length === 0 ? 'disabled' : ''}>
                                <option value="" disabled selected>-- Selecione um Horário --</option>
                                ${optionsHtml}
                            </select>
                            ${horarios.length === 0 ? '<p class="mt-2 text-red-500 font-medium"><strong>Não há horários disponíveis nestas datas.</strong></p>' : ''}
                        </div>

                        <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition duration-300">
                            Confirmar Agendamento
                        </button>
                    </form>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            document.getElementById('agendamento-form').addEventListener('submit', salvarAgendamento);
        }

        function renderAgenda() {
            const agendamentosFuturos = agendamentos.filter(a => a.data_hora.toDate().getTime() >= new Date().getTime());
            
            let tableHtml = '';

            if (agendamentosFuturos.length > 0) {
                const tableRows = agendamentosFuturos.map(a => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 whitespace-nowrap font-medium">${formatDateTime(a.data_hora.toDate())}</td>
                        <td class="p-3">${a.nome_formando}</td>
                        <td class="p-3">${a.endereco}</td>
                        <td class="p-3"><a href="mailto:${a.email_cliente}" class="text-blue-500 hover:text-blue-700">${a.email_cliente}</a></td>
                        <td class="p-3">${a.telefone || '-'}</td>
                        <td class="p-3">
                            <button onclick="excluirAgendamento('${a.id}')" class="delete-button text-xs">Excluir</button>
                        </td>
                    </tr>
                `).join('');

                tableHtml = `
                    <div class="overflow-x-auto bg-white p-6 rounded-xl shadow-2xl">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Data e Hora</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Formando</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Endereço</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">E-mail</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Telefone</th> 
                                    <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Ação</th> 
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                tableHtml = '<p class="text-lg text-gray-500 mt-4 p-4 bg-white rounded-lg shadow-md">Não há agendamentos futuros confirmados no momento.</p>';
            }

            const content = `
                <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Agenda de Visitas Agendadas</h1>
                <p class="text-gray-600 mb-6">Esta página lista todos os agendamentos confirmados em tempo real.</p>
                ${tableHtml}
            `;
            document.getElementById('app-content').innerHTML = content;

            // Expõe a função para o escopo global para ser acessada pelo HTML
            window.excluirAgendamento = excluirAgendamento;
        }

        function renderSucesso() {
            const content = `
                <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-green-500">
                    <div class="flex items-center space-x-3 mb-6">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h1 class="text-3xl font-extrabold text-gray-800">Agendamento Confirmado com Sucesso!</h1>
                    </div>
                    
                    <p class="text-gray-600">Agradecemos por agendar sua visita. Os detalhes da data e hora foram salvos no sistema.</p>
                    
                    <hr class="my-6">
                    
                    <h2 class="text-xl font-semibold text-blue-600 mb-4">O que acontece agora?</h2>
                    
                    <ol class="list-decimal list-inside space-y-2 text-gray-700 ml-4">
                        <li>Seu agendamento foi **salvo** no sistema.</li>
                        <li>Nós receberemos a notificação ao acessarmos a **Minha Agenda**.</li>
                        <li>O horário que você reservou foi **bloqueado** em tempo real e não está mais disponível para outros formandos.</li>
                    </ol>
                    <button onclick="navigate('index')" class="mt-8 bg-blue-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-600 transition duration-300">
                        Voltar para Agendamento
                    </button>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
        }

        function renderErro(message = errorMessage) {
            const content = `
                <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-red-500">
                    <div class="flex items-center space-x-3 mb-6">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <h1 class="text-3xl font-extrabold text-gray-800">Erro no Agendamento</h1>
                    </div>
                    <p class="text-xl text-red-700 font-semibold mb-4">${message}</p>
                    <p class="text-gray-600">Por favor, tente novamente.</p>
                    <button onclick="navigate('index')" class="mt-8 bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition duration-300">
                        Voltar para o Formulário
                    </button>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
        }

        function render() {
            switch (currentView) {
                case 'index':
                    renderIndex();
                    break;
                case 'agenda':
                    renderAgenda();
                    break;
                case 'sucesso':
                    renderSucesso();
                    break;
                case 'erro':
                    renderErro();
                    break;
                default:
                    renderIndex();
            }
        }

        // --- Inicialização Imediata Robusta ---

        function startApp() {
            const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            let config = null;

            if (configStr) {
                try {
                    // Tenta analisar a string JSON
                    config = JSON.parse(configStr);
                    initFirebase(config);
                } catch (e) {
                    // Se a string não for um JSON válido, mostra um erro claro
                    console.error("Erro ao analisar a configuração do Firebase:", e);
                    renderErro("Erro de Configuração (JSON Inválido): As informações do Firebase não estão no formato correto. Recarregue a página.");
                }
            } else {
                // NOVO: Solução para problema de timing do ambiente.
                // O usuário confirmou que o aplicativo funciona ao clicar no botão 'Voltar para o Formulário'.
                // Vamos simular esse clique (navigate('index')) após um pequeno atraso (500ms),
                // dando tempo para o ambiente carregar a variável.
                console.warn("Configuração do Firebase ausente. Simulação de clique de 'Voltar para o Formulário' em 500ms.");
                
                setTimeout(() => {
                    // Chamamos a função de renderização principal.
                    // Isso inicia o ciclo de renderização e, como a variável já deve ter carregado,
                    // o onAuthStateChanged no initFirebase() pega o usuário e finaliza o carregamento.
                    navigate('index');
                }, 500); 
            }
        }

        // Inicia a aplicação (Executa imediatamente)
        startApp();
    </script>
</body>
</html>



