<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda 츼lbum de Formatura</title>
 먝
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estilos b치sicos com Tailwind e CSS */
    body {
      font-family: 'Inter', sans-serif;
      background-image: url('formatura.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .container { max-width: 900px; }
    .nav-item:hover { background-color: #2563eb; color: white; }
    /* Estilos do Formul치rio */
    .form-card { max-width: 500px; }
    input[type="text"], input[type="email"], input[type="tel"], textarea, select {
      border: 1px solid #d1d5db;
      padding: 10px;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      margin-top: 4px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <header class="bg-blue-600 text-white shadow-lg">
    <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="text-xl font-bold">Agenda de Visitas</div>
      <div id="nav-links">
        <button onclick="navigate('index')" class="nav-item px-4 py-2 rounded-lg transition duration-200 bg-blue-700">Agendar Visita</button>
       먝
        <button onclick="checkPassword()" class="nav-item px-4 py-2 rounded-lg transition duration-200">Minha Agenda</button>
       먝
      </div>
    </nav>
  </header>

  <main id="app-content" class="container mx-auto p-4 md:p-8 flex-grow flex items-center justify-center">
    <div class="text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
      <p class="mt-4 text-gray-600">Carregando sistema...</p>
    </div>
  </main>
 먝
  <footer class="bg-gray-200 text-center p-4 mt-8 text-sm text-gray-600">
    <p>&copy; 2025 Evanio Martins. Todos os direitos reservados. | Status: <span id="status-display" class="font-mono text-xs">Aguardando...</span></p>
  </footer>

  <script type="module">
    // =================================================================
    // 1. CONFIGURA칂칏ES DO FIREBASE (REALTIME DATABASE - RTDB)
    // =================================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    // Importa칞칫es MUDADAS para Realtime Database
    import { getDatabase, ref, onValue, set, remove, child, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Sua configura칞칚o real
    const firebaseConfig = {
      apiKey: "AIzaSyANz1gbAi3PIGwS1-RzOIXF6SUZvS2U0mU",
      authDomain: "agenda-album-de-formatura.firebaseapp.com",
      // CHAVE RTDB obrigat칩ria e confirmada pelo seu console
      databaseURL: "https://agenda-album-de-formatura-default-rtdb.firebaseio.com",
      projectId: "agenda-album-de-formatura",
      storageBucket: "agenda-album-de-formatura.firebasestorage.app",
      messagingSenderId: "29604114447",
      appId: "1:29604114447:web:bac79aba4c4aa945c8737a"
    };
   먝
    // Inst칙ncias do Firebase
    let app;
    let db; // Inst칙ncia do RTDB
    let agendamentos = {}; // Objeto para armazenar dados do RTDB
    let currentView = 'index';
    let errorMessage = '';

    // Constantes da Aplica칞칚o
    const SEU_NOME = 'Evanio Martins';
    // Caminho da cole칞칚o no RTDB. DEVE CORRESPONDER  REGRA DE SEGURAN칂A!
    const COLLECTION_PATH = 'agendamentos';
   먝
    // 游댐 DATAS FIXAS (26/11 a 28/11)
    const DATAS_FIXAS = [
      '2025-11-26', // Quarta-feira
      '2025-11-27', // Quinta-feira
      '2025-11-28', // Sexta-feira
    ];
   먝
    // 游댐 INTERVALOS DE TEMPO (M치ximo 21:00h)
    const HORA_MAX_Geral = 21; // 21:00h
    const MINUTO_MAX_Geral = 0; // O 칰ltimo hor치rio 칠 21:00h
   먝
    const ADMIN_PASSWORD = '2025';

    // Vari치vel auxiliar para navega칞칚o (j치 que o RTDB n칚o tem onAuthStateChanged)
    let isDBReady = false;

    window.checkPassword = () => {
      const enteredPassword = window.prompt("Por favor, digite a senha de administrador para acessar a agenda:");
      if (enteredPassword === ADMIN_PASSWORD) {
        navigate('agenda');
      } else if (enteredPassword !== null) {
        alert("Senha incorreta. Acesso negado.");
      }
    };
   먝
    // Fun칞칚o para formata칞칚o de data e hora em Portugu칡s
    const formatDateTime = (date, includeTime = true, includeYear = true) => {
      const options = {
        weekday: 'long',
        day: '2-digit',
        month: '2-digit',
        year: includeYear ? 'numeric' : undefined,
        hour: includeTime ? '2-digit' : undefined,
        minute: includeTime ? '2-digit' : undefined,
        hour12: false
      };
      // Tratamento para TimeStamp de RTDB (que n칚o 칠 nativo)
      const dateObj = (date instanceof Date) ? date : new Date(date);
     먝
      return dateObj.toLocaleString('pt-BR', options)
        .replace(/\b(\w)/g, l => l.toUpperCase())
        .replace(',', ' -');
    };

    // =================================================================
    // 2. INICIALIZA칂츾O DO RTDB
    // =================================================================

    function initFirebase(config) {
      try {
        app = initializeApp(config);
        db = getDatabase(app);
        isDBReady = true;

        // N칚o precisamos de login an칪nimo. Apenas for칞amos a leitura e o uso do RTDB
        fetchAgendamentosRTDB();
       먝
        document.getElementById('status-display').textContent = 'Conectado ao RTDB';
        navigate('index'); // Carrega o formul치rio
       먝
      } catch (error) {
        console.error("Erro fatal na inicializa칞칚o do Firebase:", error);
        document.getElementById('status-display').textContent = 'Erro de Conex칚o';
        renderErro('Erro fatal: N칚o foi poss칤vel conectar ao Realtime Database. Verifique sua `databaseURL`.');
      }
    }

    // =================================================================
    // 3. OPERA칂칏ES RTDB (CRUD)
    // =================================================================
   먝
    function fetchAgendamentosRTDB() {
      if (!isDBReady) return;

      const agendamentosRef = ref(db, COLLECTION_PATH);
     먝
      // onValue: Escuta em tempo real no Realtime Database
      onValue(agendamentosRef, (snapshot) => {
        agendamentos = snapshot.val() || {}; // RTDB retorna um objeto
       먝
        // Mapeia os dados do RTDB para um formato mais amig치vel para a UI (lista plana)
        const agendamentosFormatados = [];
        for (const dataKey in agendamentos) {
          for (const horarioKey in agendamentos[dataKey]) {
            const agendamento = agendamentos[dataKey][horarioKey];
            // O ID do documento 칠 a combina칞칚o de data e hor치rio (ex: 2025-10-31/0900)
            agendamento.id = `${dataKey}/${horarioKey}`;
            // data_hora 칠 o objeto Date para compara칞칚o
           먝
            // 游댐 CORRE칂츾O: Usa o valor de 'horario' (HH:MM) para construir a data.
            agendamento.data_hora = new Date(agendamento.data + 'T' + agendamento.horario + ':00');
            agendamentosFormatados.push(agendamento);
          }
        }
        // Ordena por data_hora (do mais antigo para o mais novo)
        agendamentosFormatados.sort((a, b) => a.data_hora - b.data_hora);
       먝
        agendamentos = agendamentosFormatados;
        render();
       먝
      }, (error) => {
        console.error("Erro ao buscar agendamentos RTDB:", error);
        renderErro("Erro ao buscar agendamentos em tempo real. Verifique as Regras de Seguran칞a do Realtime Database.");
      });
    }

    async function salvarAgendamento(event) {
      event.preventDefault();
     먝
      if (!isDBReady) {
        renderErro("Erro ao salvar: A conex칚o com o banco de dados n칚o est치 pronta.");
        return;
      }

      const form = event.target;
      const dataHoraStr = form.data_hora.value;
     먝
      if (!dataHoraStr) {
        renderErro("Por favor, selecione uma data e hora.");
        return;
      }

      const dataHoraObj = new Date(dataHoraStr);
      const dataKey = dataHoraObj.toISOString().slice(0, 10); // YYYY-MM-DD
      // O hor치rio 칠 formatado para HHMM para ser usado como chave 칰nica no RTDB
      const horarioKey = dataHoraObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false }).replace(':', '');

      // 1. Verifica se o hor치rio j치 est치 reservado
      const isReserved = agendamentos.some(a => a.data_hora.getTime() === dataHoraObj.getTime());
      if (isReserved) {
        renderErro("Este hor치rio foi reservado por outro formando. Por favor, escolha outro.");
        return;
      }

      const novoAgendamento = {
        nome_formando: form.nome_formando.value.trim(),
        endereco: form.endereco.value.trim(),
        data: dataKey,
        // Salva o hor치rio em HH:MM para facilitar a leitura futura
        horario: dataHoraObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false }),
        // 游댐 CAMPO E-MAIL FOI REMOVIDO DAQUI
        telefone: form.telefone.value.trim() || null,
        criado_em: new Date().toISOString(),
        // Como n칚o tem autentica칞칚o, usamos o hor치rio para tentar simular um ID de usu치rio 칰nico de sess칚o
        sessionId: new Date().getTime().toString()
      };

      try {
        // Caminho no RTDB: agendamentos/YYYY-MM-DD/HHMM
        const agendamentoRef = ref(db, `${COLLECTION_PATH}/${dataKey}/${horarioKey}`);
       먝
        // Set() sobrescreve se existir, garantindo a atomicidade
        await set(agendamentoRef, novoAgendamento);
       먝
        navigate('sucesso');
       먝
      } catch (e) {
        console.error("Erro ao adicionar documento RTDB: ", e);
        renderErro(`Erro ao salvar no banco de dados: ${e.message}. Verifique as Regras de Seguran칞a.`);
      }
    }

    async function excluirAgendamento(id) {
      if (!isDBReady) {
        renderErro("Erro ao excluir: A conex칚o com o banco de dados n칚o est치 pronta.");
        return;
      }

      if (!window.confirm("Tem certeza que deseja excluir este agendamento?")) {
        return;
      }

      try {
        // ID do RTDB 칠 data/horario (ex: 2025-10-31/0900)
        const docRef = ref(db, `${COLLECTION_PATH}/${id}`);
        await remove(docRef);
       먝
        // onValue se encarrega de atualizar a lista
      } catch (e) {
        console.error("Erro ao excluir documento RTDB: ", e);
        renderErro(`Erro ao excluir o agendamento: ${e.message}`);
      }
    }


    // =================================================================
    // 4. L칍GICA DE AGENDAMENTO E RENDERIZA칂츾O
    // =================================================================
   먝
    function obterHorariosDisponiveis() {
      const horariosDisponiveis = [];
     먝
      // C칍PIA E AJUSTE DA HORA ATUAL PARA COMPARA칂츾O (REMOVER SEGUNDOS)
      const agora = new Date();
      agora.setSeconds(0, 0);

      // Mapeia hor치rios j치 reservados
      const horariosReservados = agendamentos.map(a => a.data_hora.getTime());

      for (const dataStr of DATAS_FIXAS) {
        const [ano, mes, dia] = dataStr.split('-').map(Number);
       먝
        // 游댐 ALTERA칂칏ES DO INTERVALO: Definir hor치rio de in칤cio e fim dinamicamente
        let HORA_INICIO; 
        const HORA_FIM = HORA_MAX_Geral; // 21h
       먝
        // Formata a data de hoje para compara칞칚o (YYYY-MM-DD)
        const hojeStr = agora.toISOString().slice(0, 10);

        if (dataStr === '2025-11-26') {
          // Quarta (26/11/2025): A partir das 17:30h. Primeiro slot de hora cheia 칠 18:00h
          HORA_INICIO = 18; 
        } else {
          // Quinta e Sexta (27/11 e 28/11): 09:00h
          HORA_INICIO = 9;
        }
        // FIM DAS ALTERA칂칏ES DO INTERVALO

        for (let hora = HORA_INICIO; hora <= HORA_FIM; hora++) {
          // GERA SLOTS APENAS DE HORA EM HORA (00)
          for (const minuto of [0]) { // Apenas 0 minutos
           먝
            const dataHoraCandidata = new Date(ano, mes - 1, dia, hora, minuto, 0, 0);
            const timestampCandidato = dataHoraCandidata.getTime();

            // Checa se o hor치rio j치 passou (para HOJE)
            if (timestampCandidato > agora.getTime()) {
              if (!horariosReservados.includes(timestampCandidato)) {
               먝
                const nomeDiaPt = formatDateTime(dataHoraCandidata, false, false);
                const horaMinuto = dataHoraCandidata.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
               먝
                horariosDisponiveis.push({
                  'display': `${nomeDiaPt} - ${dataHoraCandidata.toLocaleDateString('pt-BR')} 맙 ${horaMinuto}`,
                  'value': dataHoraCandidata.toISOString() // Formato ISO para envio
                });
              }
            }
          }
        }
      }

      return horariosDisponiveis;
    }

    window.navigate = (view, error = '') => {
      currentView = view;
      errorMessage = error;
      render();
    }

    function renderIndex() {
      const horarios = obterHorariosDisponiveis();
     먝
      const optionsHtml = horarios.length > 0
        ? horarios.map(h => `<option value="${h.value}">${h.display}</option>`).join('')
        : '<option value="" disabled>-- N칚o h치 hor치rios dispon칤veis --</option>';

      const content = `
        <div class="bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl form-card w-full max-w-lg">
          <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Agendamento de Visita</h1>
          <p class="text-gray-600 mb-8">Ol치! Para que possamos apresentar as fotos, por favor, preencha os dados e escolha um hor치rio dispon칤vel na lista abaixo.</p>

          <h2 class="text-2xl font-semibold text-blue-600 mb-6 border-b pb-2">Agende seu Hor치rio</h2>

          <form id="agendamento-form" class="space-y-6">
            <div>
              <label for="nome_formando" class="block text-sm font-medium text-gray-700">Nome Completo da crian칞a:</label>
              <input type="text" id="nome_formando" name="nome_formando" required placeholder="Ex: Jo칚o da Silva">
            </div>
           먝
            <div>
              <label for="endereco" class="block text-sm font-medium text-gray-700">Endere칞o Completo para a Visita:</label>
              <textarea id="endereco" name="endereco" required placeholder="Ex: Rua das Flores, 123, Bairro Centro" rows="2"></textarea>
            </div>

            <div>
              <label for="telefone" class="block text-sm font-medium text-gray-700">Seu Telefone (Opcional):</label>
              <input type="tel" id="telefone" name="telefone" placeholder="(DDD) 99999-9999">
            </div>

            <div>
                            <label for="data_hora" class="block text-sm font-medium text-gray-700">Escolha a Data e Hora (26/11 a partir das 18:00h, 27/11 e 28/11 das 09:00h 맙 21:00h - Hor치rios de Hora em Hora):</label>
              <select id="data_hora" name="data_hora" required class="${horarios.length === 0 ? 'bg-gray-100 text-gray-500' : ''}" ${horarios.length === 0 ? 'disabled' : ''}>
                <option value="" disabled selected>-- Selecione um Hor치rio --</option>
                ${optionsHtml}
              </select>
              ${horarios.length === 0 ? '<p class="mt-2 text-red-500 font-medium"><strong>N칚o h치 hor치rios dispon칤veis nestas datas.</strong></p>' : ''}
            </div>

            <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition duration-300">
              Confirmar Agendamento
            </button>
          </form>
        </div>
      `;
      document.getElementById('app-content').innerHTML = content;
      document.getElementById('agendamento-form').addEventListener('submit', salvarAgendamento);
    }

    function renderAgenda() {
      // Filtra os agendamentos futuros e ordena
      const agendamentosFuturos = agendamentos.filter(a => a.data_hora.getTime() >= new Date().getTime());
     먝
      let tableHtml = '';

      if (agendamentosFuturos.length > 0) {
        const tableRows = agendamentosFuturos.map(a => `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-3 whitespace-nowrap font-medium">${formatDateTime(a.data_hora)}</td>
            <td class="p-3">${a.nome_formando}</td>
            <td class="p-3">${a.endereco}</td>
            <td class="p-3">--</td>             <td class="p-3">${a.telefone || '-'}</td>
            <td class="p-3">
              <button onclick="excluirAgendamento('${a.id}')" class="delete-button text-xs">Excluir</button>
            </td>
          </tr>
        `).join('');

        tableHtml = `
          <div class="overflow-x-auto bg-white bg-opacity-95 p-6 rounded-xl shadow-2xl">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Data e Hora</th>
                  <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Formando</th>
                  <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Endere칞o</th>
                  <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">E-mail</th>                   <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Telefone</th>
                  <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">A칞칚o</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;
      } else {
        tableHtml = '<p class="text-lg text-gray-500 mt-4 p-4 bg-white bg-opacity-95 rounded-lg shadow-md">N칚o h치 agendamentos futuros confirmados no momento.</p>';
      }

      const content = `
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Agenda de Visitas Agendadas</h1>
        <p class="text-gray-600 mb-6">Esta p치gina lista todos os agendamentos confirmados em tempo real.</p>
        ${tableHtml}
      `;
      document.getElementById('app-content').innerHTML = content;

      // Exp칫e a fun칞칚o para o escopo global para ser acessada pelo HTML
      window.excluirAgendamento = excluirAgendamento;
    }

    function renderSucesso() {
      const content = `
        <div class="bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl border-t-4 border-green-500">
          <div class="flex items-center space-x-3 mb-6">
            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h1 class="text-3xl font-extrabold text-gray-800">Agendamento Confirmado com Sucesso!</h1>
          </div>
         먝
          <p class="text-gray-600">Agradecemos por agendar sua visita. Os detalhes da data e hora foram salvos no sistema.</p>
         먝
          <hr class="my-6">
         먝
          <h2 class="text-xl font-semibold text-blue-600 mb-4">O que acontece agora?</h2>
         먝
          <ol class="list-decimal list-inside space-y-2 text-gray-700 ml-4">
            <li>Seu agendamento foi **salvo** no sistema.</li>
            <li>O hor치rio que voc칡 reservou foi **bloqueado** em tempo real e n칚o est치 mais dispon칤vel para outros formandos.</li>
          </ol>
          <button onclick="navigate('index')" class="mt-8 bg-blue-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-600 transition duration-300">
            Voltar para Agendamento
          </button>
        </div>
      `;
      document.getElementById('app-content').innerHTML = content;
    }

    function renderErro(message = errorMessage) {
      const content = `
        <div class="bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl border-t-4 border-red-500">
          <div class="flex items-center space-x-3 mb-6">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            <h1 class="text-3xl font-extrabold text-gray-800">Erro no Agendamento</h1>
          </div>
          <p class="text-xl text-red-700 font-semibold mb-4">${message}</p>
          <p class="text-gray-600">Por favor, tente novamente.</p>
          <button onclick="navigate('index')" class="mt-8 bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition duration-300">
            Voltar para o Formul치rio
          </button>
        </div>
      `;
      document.getElementById('app-content').innerHTML = content;
    }

    function render() {
      switch (currentView) {
        case 'index':
          renderIndex();
          break;
        case 'agenda':
          renderAgenda();
          break;
        case 'sucesso':
          renderSucesso();
          break;
        case 'erro':
          renderErro();
          break;
        default:
          renderIndex();
      }
    }

    // --- Inicializa칞칚o Imediata Robusta ---

    function startApp() {
      // N칚o precisamos mais de __firebase_config, pois a configura칞칚o est치 embutida
      initFirebase(firebaseConfig);
    }

    // Inicia a aplica칞칚o (Executa imediatamente)
    startApp();
  </script>
</body>
</html>
