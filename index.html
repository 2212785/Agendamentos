<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agenda Álbum de Formatura</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: url('formatura.jpg'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed;
        }
        .container { max-width: 900px; }
        .nav-item:hover { background-color: #2563eb; color: white; }
        .form-card { max-width: 500px; }
        input[type="text"], input[type="email"], input[type="tel"], textarea, select {
            border: 1px solid #d1d5db;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-blue-600 text-white shadow-lg">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold">Agenda de Visitas</div>
            <div id="nav-links">
                <button onclick="navigate('index')" class="nav-item px-4 py-2 rounded-lg transition duration-200 bg-blue-700">Agendar Visita</button>
                <button onclick="checkPassword()" class="nav-item px-4 py-2 rounded-lg transition duration-200">Minha Agenda</button>
            </div>
        </nav>
    </header>

    <main id="app-content" class="container mx-auto p-4 md:p-8 flex-grow flex items-center justify-center"> 
        <div class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Carregando sistema...</p>
        </div>
    </main>
    
    <footer class="bg-gray-200 text-center p-4 mt-8 text-sm text-gray-600">
        <p>&copy; 2026 Evanio Martins. Todos os direitos reservados. | Status: <span id="status-display" class="font-mono text-xs">Aguardando...</span></p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyANz1gbAi3PIGwS1-RzOIXF6SUZvS2U0mU", 
            authDomain: "agenda-album-de-formatura.firebaseapp.com",
            databaseURL: "https://agenda-album-de-formatura-default-rtdb.firebaseio.com", 
            projectId: "agenda-album-de-formatura",
            storageBucket: "agenda-album-de-formatura.firebasestorage.app",
            messagingSenderId: "29604114447",
            appId: "1:29604114447:web:bac79aba4c4aa945c8737a"
        };
        
        let app, db;
        let agendamentos = []; 
        let currentView = 'index';
        let errorMessage = '';
        let isDBReady = false;

        const ADMIN_PASSWORD = '2025';
        const COLLECTION_PATH = 'agendamentos'; 

        // ---------------------------------------------------------
        // NOVAS CONFIGURAÇÕES DE DATAS E HORÁRIOS (2026)
        // ---------------------------------------------------------
        const DATAS_FIXAS = [
            '2026-01-09', // Sexta
            '2026-01-10', // Sábado
            '2026-01-11', // Domingo
            '2026-01-12', // Segunda
            '2026-01-13', // Terça
            '2026-01-14'  // Quarta
        ];

        window.checkPassword = () => {
            const enteredPassword = window.prompt("Digite a senha de administrador:");
            if (enteredPassword === ADMIN_PASSWORD) navigate('agenda');
            else if (enteredPassword !== null) alert("Senha incorreta.");
        };
        
        const formatDateTime = (date) => {
            const dateObj = (date instanceof Date) ? date : new Date(date);
            const weekday = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
            const dayMonth = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            const time = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
            const weekdayCapitalized = weekday.charAt(0).toUpperCase() + weekday.slice(1);
            return `${weekdayCapitalized} ${dayMonth} às ${time}`;
        };

        function initFirebase(config) {
            try {
                app = initializeApp(config);
                db = getDatabase(app); 
                isDBReady = true;
                fetchAgendamentosRTDB(); 
                document.getElementById('status-display').textContent = 'Conectado ao RTDB';
                navigate('index'); 
            } catch (error) {
                console.error("Erro Firebase:", error);
                document.getElementById('status-display').textContent = 'Erro na Conexão';
            }
        }

        function fetchAgendamentosRTDB() {
            if (!isDBReady) return;
            const agendamentosRef = ref(db, COLLECTION_PATH);
            onValue(agendamentosRef, (snapshot) => {
                const data = snapshot.val() || {};
                const formatados = [];
                for (const dateKey in data) {
                    for (const hourKey in data[dateKey]) {
                        const item = data[dateKey][hourKey];
                        item.id = `${dateKey}/${hourKey}`;
                        item.data_hora = new Date(item.data + 'T' + item.horario + ':00');
                        formatados.push(item);
                    }
                }
                formatados.sort((a, b) => a.data_hora - b.data_hora);
                agendamentos = formatados;
                render();
            });
        }

        async function salvarAgendamento(event) {
            event.preventDefault();
            if (!isDBReady) return;

            const form = event.target;
            const dataHoraStr = form.data_hora.value;
            if (!dataHoraStr) return;

            const dataHoraObj = new Date(dataHoraStr);
            const dataKey = dataHoraObj.toISOString().slice(0, 10);
            const horarioKey = dataHoraObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }).replace(':', '');

            const isReserved = agendamentos.some(a => a.data_hora.getTime() === dataHoraObj.getTime());
            if (isReserved) {
                alert("Horário já reservado.");
                return;
            }

            const novoAgendamento = {
                nome_formando: form.nome_formando.value.trim(),
                endereco: form.endereco.value.trim(),
                data: dataKey,
                horario: dataHoraObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                telefone: form.telefone.value.trim() || null,
                criado_em: new Date().toISOString()
            };

            try {
                await set(ref(db, `${COLLECTION_PATH}/${dataKey}/${horarioKey}`), novoAgendamento);
                navigate('sucesso');
            } catch (e) {
                alert("Erro ao salvar: " + e.message);
            }
        }

        window.excluirAgendamento = async (id) => {
            if (window.confirm("Excluir agendamento?")) {
                await remove(ref(db, `${COLLECTION_PATH}/${id}`));
            }
        };

        // ---------------------------------------------------------
        // LÓGICA DE HORÁRIOS ATUALIZADA (REGRAS DE 09/01 A 14/01)
        // ---------------------------------------------------------
        function obterHorariosDisponiveis() {
            const disponiveis = [];
            const agora = new Date();
            const reservados = agendamentos.map(a => a.data_hora.getTime());

            for (const dataStr of DATAS_FIXAS) {
                const [ano, mes, dia] = dataStr.split('-').map(Number);
                
                let hInicio, hFim, mFim;

                if (dataStr === '2026-01-09') {
                    // Sexta 09/01: 18:00 às 20:30
                    hInicio = 18; hFim = 20; mFim = 30;
                } else {
                    // Sábado 10/01 até Quarta 14/01: 09:00 às 20:30
                    hInicio = 9; hFim = 20; mFim = 30;
                }

                const totalMinutosFim = (hFim * 60) + mFim;

                for (let h = hInicio; h <= hFim; h++) {
                    for (const m of [0, 30]) {
                        if ((h * 60) + m > totalMinutosFim) continue;

                        const candidata = new Date(ano, mes - 1, dia, h, m, 0);
                        if (candidata > agora && !reservados.includes(candidata.getTime())) {
                            disponiveis.push({
                                display: formatDateTime(candidata),
                                value: candidata.toISOString()
                            });
                        }
                    }
                }
            }
            return disponiveis;
        }

        window.navigate = (view) => {
            currentView = view;
            render();
        };

        function renderIndex() {
            const horarios = obterHorariosDisponiveis();
            const options = horarios.map(h => `<option value="${h.value}">${h.display}</option>`).join('');

            document.getElementById('app-content').innerHTML = `
                <div class="bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl form-card w-full"> 
                    <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Agendamento de Visita</h1>
                    <p class="text-gray-600 mb-8">Escolha um horário para apresentação do álbum de formatura.</p>
                    <form id="agendamento-form" class="space-y-6">
                        <input type="text" name="nome_formando" required placeholder="Nome Completo da criança">
                        <textarea name="endereco" required placeholder="Endereço Completo para a Visita" rows="2"></textarea>
                        <input type="tel" name="telefone" placeholder="Seu Telefone (Opcional)">
                        <select name="data_hora" required>
                            <option value="" disabled selected>-- Selecione um Horário --</option>
                            ${options}
                        </select>
                        <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition">Confirmar Agendamento</button>
                    </form>
                </div>`;
            document.getElementById('agendamento-form').addEventListener('submit', salvarAgendamento);
        }

        function renderAgenda() {
            const futuros = agendamentos.filter(a => a.data_hora >= new Date());
            const rows = futuros.map(a => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 text-sm">${formatDateTime(a.data_hora)}</td>
                    <td class="p-3 text-sm">${a.nome_formando}</td>
                    <td class="p-3 text-sm">${a.endereco}</td>
                    <td class="p-3 text-sm">${a.telefone || '-'}</td>
                    <td class="p-3"><button onclick="excluirAgendamento('${a.id}')" class="text-red-500 text-xs font-bold">Excluir</button></td>
                </tr>`).join('');

            document.getElementById('app-content').innerHTML = `
                <div class="bg-white bg-opacity-95 p-6 rounded-xl shadow-2xl w-full overflow-x-auto">
                    <h1 class="text-2xl font-bold mb-4">Agenda Confirmada</h1>
                    <table class="w-full text-left">
                        <thead><tr class="bg-gray-100 text-xs uppercase">
                            <th class="p-3">Data/Hora</th><th class="p-3">Criança</th><th class="p-3">Endereço</th><th class="p-3">Telefone</th><th class="p-3">Ação</th>
                        </tr></thead>
                        <tbody>${rows || '<tr><td colspan="5" class="p-4 text-center">Nenhum agendamento.</td></tr>'}</tbody>
                    </table>
                    <button onclick="navigate('index')" class="mt-4 text-blue-600 font-bold">Voltar</button>
                </div>`;
        }

        function renderSucesso() {
            document.getElementById('app-content').innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl text-center">
                    <h2 class="text-2xl font-bold text-green-600 mb-4">Sucesso!</h2>
                    <p class="text-gray-600 mb-6">Seu agendamento foi salvo e o horário bloqueado.</p>
                    <button onclick="navigate('index')" class="bg-blue-500 text-white px-6 py-2 rounded-lg">Voltar</button>
                </div>`;
        }

        function render() {
            if (currentView === 'agenda') renderAgenda();
            else if (currentView === 'sucesso') renderSucesso();
            else renderIndex();
        }

        initFirebase(firebaseConfig);
    </script>
</body>
</html>
