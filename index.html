<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Visita - Firestore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ===================================================================
        ESTILOS DE FUNDO PARA A IMAGEM DE FORMATURA
        ===================================================================
        */
        body { 
            font-family: 'Inter', sans-serif; 
            
            /* Caminho ajustado para a raiz, conforme discutido. */
            background-image: url('formatura.jpg'); 
            
            background-size: cover; /* Cobre toda a área */
            background-position: center; /* Centraliza a imagem */
            background-attachment: fixed; /* Opcional: faz a imagem ficar fixa ao rolar a página */
        }
        
        .nav-item:hover { background-color: #2563eb; color: white; }
        .container { max-width: 900px; }
        .delete-button { background-color: #ef4444; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .delete-button:hover { background-color: #dc2626; }
        input[type="text"], input[type="email"], input[type="tel"], textarea, select {
            border: 1px solid #d1d5db;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-blue-600 text-white shadow-lg">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold">Agenda de Visitas</div>
            <div id="nav-links">
                <button onclick="navigate('index')" class="nav-item px-4 py-2 rounded-lg transition duration-200 bg-blue-700">Agendar Visita</button>
                
                <button onclick="checkPassword()" class="nav-item px-4 py-2 rounded-lg transition duration-200">Minha Agenda</button>
                
            </div>
        </nav>
    </header>

    <main id="app-content" class="container mx-auto p-4 md:p-8 flex-grow flex items-center justify-center"> 
        <div class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Carregando sistema...</p>
        </div>
    </main>

    <footer class="bg-gray-200 text-center p-4 mt-8 text-sm text-gray-600">
        <p>&copy; 2025 Evanio Martins. Todos os direitos reservados. | Usuário: <span id="user-id-display" class="font-mono text-xs">Aguardando...</span></p>
        <p class="mt-2 text-xs text-red-600">Aviso: A função de envio de e-mail foi removida, pois requer um serviço de backend (como o Flask original). Para enviar e-mails, você precisará de uma API externa (ex: SendGrid, EmailJS).</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variáveis Globais de Configuração (Fornecidas pelo ambiente Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Instâncias do Firebase
        let app;
        let auth;
        let db;
        let userId = null;
        let agendamentos = [];
        let currentView = 'index';
        let errorMessage = '';
        let isFirebaseInitialized = false; 

        // ========================================================================
        // ONDE FAZER: Configuração do Firebase (Fallback)
        // ESSA CONFIGURAÇÃO GARANTE QUE A APLICAÇÃO INICIE SE O AMBIENTE FALHAR
        // ========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyANz1gbAi3PIGwS1-RzOIXF6SUZvS2U0mU",
            authDomain: "agenda-album-de-formatura.firebaseapp.com",
            databaseURL: "https://agenda-album-de-formatura-default-rtdb.firebaseio.com",
            projectId: "agenda-album-de-formatura",
            storageBucket: "agenda-album-de-formatura.firebasestorage.app",
            messagingSenderId: "29604114447",
            appId: "1:29604114447:web:bac79aba4c4aa945c8737a"
        };
        // ========================================================================

        // Constantes da Aplicação
        const SEU_NOME = 'Evanio Martins';
        const COLLECTION_PATH = `artifacts/${appId}/public/data/agendamentos`;
        
        // -------------------------------------------------------------
        // NOVO CÓDIGO: SENHA E FUNÇÃO DE VERIFICAÇÃO DE ACESSO
        // -------------------------------------------------------------
        const ADMIN_PASSWORD = 'minhaagenda2025'; // <<--- SUA SENHA SECRETA AQUI!

        window.checkPassword = () => {
            // Solicita a senha ao usuário
            const enteredPassword = window.prompt("Por favor, digite a senha de administrador para acessar a agenda:");
            
            // Compara a senha digitada
            if (enteredPassword === ADMIN_PASSWORD) {
                // Se a senha estiver correta, navega para a agenda (função original)
                navigate('agenda');
            } else if (enteredPassword !== null) {
                // Se digitou algo errado
                alert("Senha incorreta. Acesso negado.");
            }
            // Se o usuário clicar em Cancelar, nada acontece.
        };
        // -------------------------------------------------------------

        const DATAS_FIXAS = [
            '2025-10-31', // Sexta-feira
            '2025-11-01', // Sábado
            '2025-11-02', // Domingo
            '2025-11-03', // Segunda-feira
        ];
        const HORA_INICIO = 9;
        const HORA_FIM = 20; // Inclui 20:00h

        // Função para formatação de data e hora em Português
        const formatDateTime = (date, includeTime = true, includeYear = true) => {
            const options = { 
                weekday: 'long', 
                day: '2-digit', 
                month: '2-digit', 
                year: includeYear ? 'numeric' : undefined,
                hour: includeTime ? '2-digit' : undefined, 
                minute: includeTime ? '2-digit' : undefined,
                hour12: false
            };
            return new Date(date).toLocaleString('pt-BR', options)
                .replace(/\b(\w)/g, l => l.toUpperCase()) // Capitaliza dias da semana e meses
                .replace(',', ' -'); // Ajusta a separação entre dia e data
        };

        // =================================================================
        // 1. INICIALIZAÇÃO E AUTENTICAÇÃO DO FIREBASE
        // =================================================================

        function initFirebase(config) {
            if (!config) {
                console.error("Erro: Configuração do Firebase não foi fornecida.");
                renderErro("Erro fatal: As configurações do Firebase estão ausentes.");
                return;
            }

            app = initializeApp(config);
            auth = getAuth(app);
            db = getFirestore(app); // DB É DEFINIDO AQUI!

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    fetchAgendamentos(); // Inicia a escuta após a autenticação
                    
                    // CORREÇÃO: SÓ NAVEGA PARA A TELA INICIAL APÓS O LOGIN E A CONFIGURAÇÃO DO DB
                    if (!isFirebaseInitialized) {
                            navigate('index'); 
                            isFirebaseInitialized = true;
                    }
                } else {
                    // Tenta autenticar
                    try {
                        if (initialAuthToken) {
                            const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                            userId = userCredential.user.uid;
                        } else {
                            // Se o token não estiver disponível, faz o login anônimo
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                        }
                        document.getElementById('user-id-display').textContent = userId;
                    } catch (error) {
                        console.error("Erro na autenticação:", error);
                        renderErro('Não foi possível conectar ao sistema de autenticação. Tente recarregar a página.');
                    }
                }
            });
        }
        
        // =================================================================
        // 2. LÓGICA DE AGENDAMENTO (GERAÇÃO E FILTRAGEM)
        // =================================================================

        function obterHorariosDisponiveis() {
            const horariosDisponiveis = [];
            const agora = new Date();
            const horariosReservados = agendamentos.map(a => a.data_hora.toDate().getTime());

            for (const dataStr of DATAS_FIXAS) {
                const [ano, mes, dia] = dataStr.split('-').map(Number);
                
                for (let hora = HORA_INICIO; hora <= HORA_FIM; hora++) {
                    // Cria o objeto Date para a hora cheia
                    const dataHoraCandidata = new Date(ano, mes - 1, dia, hora, 0, 0, 0);
                    const timestampCandidato = dataHoraCandidata.getTime();
                    
                    // 1. Checa se o horário ainda não passou
                    if (timestampCandidato > agora.getTime()) {
                        // 2. Checa se o horário já foi reservado
                        if (!horariosReservados.includes(timestampCandidato)) {
                            
                            const nomeDiaPt = formatDateTime(dataHoraCandidata, false, false);
                            const horaMinuto = dataHoraCandidata.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
                            
                            horariosDisponiveis.push({
                                // Exemplo de formato: "Sexta-feira, 31/10/2025 às 09:00"
                                'display': `${nomeDiaPt} - ${dataHoraCandidata.toLocaleDateString('pt-BR')} às ${horaMinuto}`,
                                'value': dataHoraCandidata.toISOString() // Formato ISO para envio
                            });
                        }
                    }
                }
            }

            return horariosDisponiveis;
        }

        // =================================================================
        // 3. OPERAÇÕES FIREBASE (CRUD)
        // =================================================================

        function fetchAgendamentos() {
            // VERIFICAÇÃO DE SEGURANÇA MANTIDA
            if (!db || !userId) return; 

            const agendamentosRef = collection(db, COLLECTION_PATH);
            const q = query(agendamentosRef, orderBy('data_hora'));

            // Escuta em tempo real (onSnapshot)
            onSnapshot(q, (snapshot) => {
                agendamentos = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Garante que a tela será renderizada após a busca inicial
                render();
            }, (error) => {
                console.error("Erro ao buscar agendamentos:", error);
                renderErro("Erro ao buscar agendamentos em tempo real.");
            });
        }

        async function salvarAgendamento(event) {
            event.preventDefault();
            
            // VERIFICAÇÃO DE SEGURANÇA MANTIDA (AQUI OCORRIA O ERRO ANTERIORMENTE)
            if (!db) {
                renderErro("Erro ao salvar no banco de dados: A conexão com o Firestore não foi estabelecida. Tente recarregar a página.");
                return;
            }

            const form = event.target;
            const dataHoraStr = form.data_hora.value;
            
            if (!dataHoraStr) {
                renderErro("Por favor, selecione uma data e hora.");
                return;
            }

            const dataHoraObj = new Date(dataHoraStr);

            // Verifica novamente se o horário está disponível antes de salvar
            const isReserved = agendamentos.some(a => a.data_hora.toDate().getTime() === dataHoraObj.getTime());
            if (isReserved) {
                renderErro("Este horário foi reservado por outro formando. Por favor, escolha outro.");
                return;
            }

            const novoAgendamento = {
                nome_formando: form.nome_formando.value.trim(),
                endereco: form.endereco.value.trim(),
                data_hora: dataHoraObj, // Salva como Timestamp
                email_cliente: form.email_cliente.value.trim(),
                telefone: form.telefone.value.trim() || null,
                criado_em: serverTimestamp(),
                userId: userId, // Identifica quem criou o agendamento
            };

            try {
                const agendamentosRef = collection(db, COLLECTION_PATH);
                await addDoc(agendamentosRef, novoAgendamento);
                navigate('sucesso');
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                renderErro(`Erro ao salvar no banco de dados: ${e.message}`);
            }
        }

        async function excluirAgendamento(id) {
            // VERIFICAÇÃO DE SEGURANÇA MANTIDA
            if (!db) {
                renderErro("Erro ao excluir: A conexão com o Firestore não foi estabelecida.");
                return;
            }

            // Usamos uma modal simples no lugar de 'confirm()' (que é bloqueado)
            if (!window.confirm("Tem certeza que deseja excluir este agendamento?")) {
                 return;
            }

            try {
                const docRef = doc(db, COLLECTION_PATH, id);
                await deleteDoc(docRef);
                // A navegação para 'agenda' é automática via onSnapshot
            } catch (e) {
                console.error("Erro ao excluir documento: ", e);
                renderErro(`Erro ao excluir o agendamento: ${e.message}`);
            }
        }


        // =================================================================
        // 4. RENDERIZAÇÃO DA INTERFACE (VIEWS)
        // =================================================================

        window.navigate = (view, error = '') => {
            currentView = view;
            errorMessage = error;
            render();
        }

        function renderIndex() {
            const horarios = obterHorariosDisponiveis();
            
            const optionsHtml = horarios.length > 0
                ? horarios.map(h => `<option value="${h.value}">${h.display}</option>`).join('')
                : '<option value="" disabled>-- Não há horários disponíveis --</option>';

            const content = `
                <div class="bg-white bg-opacity-95 p-8 rounded-xl shadow-2xl w-full max-w-lg"> 
                    <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Agendamento de Visita</h1>
                    <p class="text-gray-600 mb-8">Olá! Para que possamos apresentar os álbuns de formatura, por favor, preencha os dados e escolha um horário disponível na lista abaixo.</p>

                    <h2 class="text-2xl font-semibold text-blue-600 mb-6 border-b pb-2">Agende seu Horário</h2>

                    <form id="agendamento-form" class="space-y-6">
                        <div>
                            <label for="nome_formando" class="block text-sm font-medium text-gray-700">Nome Completo do Formando(a):</label>
                            <input type="text" id="nome_formando" name="nome_formando" required placeholder="Ex: João da Silva">
                        </div>
                        
                        <div>
                            <label for="email_cliente" class="block text-sm font-medium text-gray-700">Seu E-mail (Para receber a confirmação):</label>
                            <input type="email" id="email_cliente" name="email_cliente" required placeholder="Ex: joao@email.com">
                        </div>

                        <div>
                            <label for="endereco" class="block text-sm font-medium text-gray-700">Endereço Completo para a Visita:</label>
                            <textarea id="endereco" name="endereco" required placeholder="Ex: Rua das Flores, 123, Bairro Centro" rows="2"></textarea>
                        </div>

                        <div>
                            <label for="telefone" class="block text-sm font-medium text-gray-700">Seu Telefone (Opcional):</label>
                            <input type="tel" id="telefone" name="telefone" placeholder="(DDD) 99999-9999">
                        </div>

                        <div>
                            <label for="data_hora" class="block text-sm font-medium text-gray-700">Escolha a Data e Hora (Horários de ${HORA_INICIO}:00h às ${HORA_FIM}:00h):</label>
                            <select id="data_hora" name="data_hora" required class="${horarios.length === 0 ? 'bg-gray-100 text-gray-500' : ''}" ${horarios.length === 0 ? 'disabled' : ''}>
                                <option value="" disabled selected>-- Selecione um Horário --</option>
                                ${optionsHtml}
                            </select>
                            ${horarios.length === 0 ? '<p class="mt-2 text-red-500 font-medium"><strong>Não há horários disponíveis nestas datas.</strong></p>' : ''}
                        </div>

                        <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition duration-300">
                            Confirmar Agendamento
                        </button>
                    </form>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            document.getElementById('agendamento-form').addEventListener('submit', salvarAgendamento);
        }

        function renderAgenda() {
            const agendamentosFuturos = agendamentos.filter(a => a.data_hora.toDate().getTime() >= new Date().getTime());
            
            let tableHtml = '';

            if (agendamentosFuturos.length > 0) {
                const tableRows = agendamentosFuturos.map(a => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 whitespace-nowrap font-medium">${formatDateTime(a.data_hora.toDate())}</td>
                        <td class="p-3">${a.nome_formando}</td>
                        <td class="p-3">${a.endereco}</td>
                        <td class="p-3"><a href="mailto:${a.email_cliente}" class="text-blue-500 hover:text-blue-700">${a.email_cliente}</a></td>
                        <td class="p-3">${a.telefone || '-'}</td>
                        <td class="p-3">
                            <button onclick="excluirAgendamento('${a.id}')" class="delete-button text-xs">Excluir</button>
                        </td>
                    </tr>
                `).join('');

                tableHtml = `
                    <div class="overflow-x-auto bg-white bg-opacity-95 p-6 rounded-xl shadow-2xl">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-



