<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agenda √Ålbum de Formatura - Encerrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: url('https://images.unsplash.com/photo-1523050853063-9158946122a2?q=80&w=2070&auto=format&fit=crop'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed;
        }
        .container { max-width: 900px; }
        .nav-item:hover { background-color: #2563eb; color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-blue-600 text-white shadow-lg">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold">Agenda de Visitas</div>
            <div id="nav-links">
                <button onclick="navigate('index')" class="nav-item px-4 py-2 rounded-lg transition duration-200 bg-blue-700">In√≠cio</button>
                <button onclick="checkPassword()" class="nav-item px-4 py-2 rounded-lg transition duration-200">Minha Agenda</button>
            </div>
        </nav>
    </header>

    <main id="app-content" class="container mx-auto p-4 md:p-8 flex-grow flex items-center justify-center"> 
        <div class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Carregando...</p>
        </div>
    </main>
    
    <footer class="bg-gray-200 text-center p-4 mt-8 text-sm text-gray-600">
        <p>&copy; 2026 Evanio Martins. Todos os direitos reservados. | Status: <span id="status-display" class="font-mono text-xs text-red-600">Agendamentos Encerrados</span></p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyANz1gbAi3PIGwS1-RzOIXF6SUZvS2U0mU", 
            authDomain: "agenda-album-de-formatura.firebaseapp.com",
            databaseURL: "https://agenda-album-de-formatura-default-rtdb.firebaseio.com", 
            projectId: "agenda-album-de-formatura",
            storageBucket: "agenda-album-de-formatura.firebasestorage.app",
            messagingSenderId: "29604114447",
            appId: "1:29604114447:web:bac79aba4c4aa945c8737a"
        };
        
        let app, db;
        let agendamentos = []; 
        let currentView = 'index';
        let isDBReady = false;

        const ADMIN_PASSWORD = '2025';
        const COLLECTION_PATH = 'agendamentos'; 

        // Fun√ß√µes Globais
        window.checkPassword = () => {
            const enteredPassword = window.prompt("Digite a senha de administrador:");
            if (enteredPassword === ADMIN_PASSWORD) {
                navigate('agenda');
            } else if (enteredPassword !== null) {
                alert("Senha incorreta.");
            }
        };

        window.navigate = (view) => {
            currentView = view;
            render();
        };

        window.excluirAgendamento = async (id) => {
            if (window.confirm("Deseja realmente excluir este agendamento?")) {
                try {
                    await remove(ref(db, `${COLLECTION_PATH}/${id}`));
                } catch (error) {
                    alert("Erro ao excluir: " + error.message);
                }
            }
        };
        
        const formatDateTime = (date) => {
            const dateObj = (date instanceof Date) ? date : new Date(date);
            const weekday = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
            const dayMonth = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            const time = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
            return `${weekday.charAt(0).toUpperCase() + weekday.slice(1)} ${dayMonth} √†s ${time}`;
        };

        function initFirebase(config) {
            try {
                app = initializeApp(config);
                db = getDatabase(app); 
                isDBReady = true;
                fetchAgendamentosRTDB(); 
                document.getElementById('status-display').textContent = 'Encerrado (Consulta Liberada)';
            } catch (error) {
                document.getElementById('status-display').textContent = 'Erro de Conex√£o';
                console.error(error);
            }
        }

        function fetchAgendamentosRTDB() {
            if (!isDBReady) return;
            const agendamentosRef = ref(db, COLLECTION_PATH);
            onValue(agendamentosRef, (snapshot) => {
                const data = snapshot.val() || {};
                const formatados = [];
                
                // Percorre a estrutura de data/hora do Realtime Database
                for (const dateKey in data) {
                    for (const hourKey in data[dateKey]) {
                        const item = data[dateKey][hourKey];
                        // Preserva a chave original para exclus√£o correta
                        item.id = `${dateKey}/${hourKey}`;
                        // Cria objeto Date para ordena√ß√£o
                        item.data_hora = new Date(`${item.data}T${item.horario}:00`);
                        formatados.push(item);
                    }
                }
                
                // Ordena por data e hora mais pr√≥xima
                formatados.sort((a, b) => a.data_hora - b.data_hora);
                agendamentos = formatados;
                render();
            });
        }

        function renderIndex() {
            document.getElementById('app-content').innerHTML = `
                <div class="bg-white bg-opacity-95 p-10 rounded-2xl shadow-2xl max-w-lg w-full text-center border-t-8 border-blue-600"> 
                    <div class="text-blue-600 text-6xl mb-6">üëã</div>
                    <h1 class="text-3xl font-extrabold text-gray-800 mb-4">Obrigado, Mar√≠lia!</h1>
                    <p class="text-lg text-gray-700 leading-relaxed mb-6">
                        Gostar√≠amos de agradecer a todos os formandos e familiares pelo carinho e recep√ß√£o. 
                    </p>
                    <div class="bg-blue-50 p-6 rounded-xl mb-6 border border-blue-100">
                        <p class="text-blue-800 font-bold text-xl uppercase tracking-wide">
                            Aten√ß√£o
                        </p>
                        <p class="text-blue-700 mt-2 font-medium">
                            Estamos encerrando nosso atendimento na cidade de Mar√≠lia **hoje ao meio-dia**.
                        </p>
                    </div>
                    <p class="text-gray-500 text-sm italic">
                        N√£o estamos mais aceitando novos agendamentos pelo sistema. 
                        Para informa√ß√µes sobre √°lbuns j√° adquiridos, entre em contato diretamente conosco.
                    </p>
                </div>`;
        }

        function renderAgenda() {
            const rowHtml = agendamentos.map(a => `
                <tr class="border-b hover:bg-gray-50 text-xs sm:text-sm">
                    <td class="p-3 font-medium">${formatDateTime(a.data_hora)}</td>
                    <td class="p-3 text-blue-700 font-bold">${a.numero_foto || '-'}</td>
                    <td class="p-3">${a.nome_formando}</td>
                    <td class="p-3">${a.endereco}</td>
                    <td class="p-3 text-center">
                        <button onclick="excluirAgendamento('${a.id}')" class="text-red-500 hover:text-red-700 font-bold">Excluir</button>
                    </td>
                </tr>`).join('');

            document.getElementById('app-content').innerHTML = `
                <div class="bg-white bg-opacity-95 p-4 rounded-xl shadow-2xl w-full overflow-x-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-2xl font-bold text-gray-800">Relat√≥rio Final - Mar√≠lia</h1>
                        <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold uppercase">Agendamentos Suspensos</span>
                    </div>
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-[10px] uppercase text-gray-600">
                                <th class="p-3">Data/Hora</th>
                                <th class="p-3">Foto N¬∫</th>
                                <th class="p-3">Formando</th>
                                <th class="p-3">Endere√ßo</th>
                                <th class="p-3 text-center">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowHtml || '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhum agendamento encontrado.</td></tr>'}
                        </tbody>
                    </table>
                    <div class="mt-6 flex justify-between items-center">
                        <button onclick="navigate('index')" class="text-blue-600 hover:underline font-bold">‚Üê Voltar ao In√≠cio</button>
                        <span class="text-gray-500 text-xs">Total de registros: ${agendamentos.length}</span>
                    </div>
                </div>`;
        }

        function render() {
            if (currentView === 'agenda') renderAgenda();
            else renderIndex();
        }

        // Inicializa√ß√£o
        initFirebase(firebaseConfig);
    </script>
</body>
</html>
