<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agenda Álbum de Formatura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: url('https://images.unsplash.com/photo-1523050853063-9158946122a2?q=80&w=2070&auto=format&fit=crop'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed;
        }
        .container { max-width: 1000px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-blue-600 text-white shadow-lg">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold">Agenda de Visitas</div>
            <div class="flex gap-4">
                <button onclick="location.reload()" class="text-sm bg-blue-700 px-3 py-1 rounded-lg hover:bg-blue-800 transition">Atualizar</button>
            </div>
        </nav>
    </header>

    <main id="app-content" class="container mx-auto p-4 md:p-8 flex-grow">
        <div class="text-center py-12 bg-white bg-opacity-90 rounded-xl p-8 shadow-lg max-w-md mx-auto">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600 font-medium">Carregando sistema de agendamento...</p>
        </div>
    </main>
    
    <footer class="bg-gray-200 text-center p-4 mt-8 text-sm text-gray-600">
        <p>&copy; 2026 Evanio Martins. | Status: <span id="status-display" class="font-mono text-xs text-green-600">Sistema Ativo</span></p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyANz1gbAi3PIGwS1-RzOIXF6SUZvS2U0mU", 
            authDomain: "agenda-album-de-formatura.firebaseapp.com",
            databaseURL: "https://agenda-album-de-formatura-default-rtdb.firebaseio.com", 
            projectId: "agenda-album-de-formatura",
            storageBucket: "agenda-album-de-formatura.firebasestorage.app",
            messagingSenderId: "29604114447",
            appId: "1:29604114447:web:bac79aba4c4aa945c8737a"
        };
        
        let app, db;
        let agendamentos = []; 
        const COLLECTION_PATH = 'agendamentos'; 

        // Inicializa Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app); 
            fetchAgendamentos();
        } catch (error) {
            console.error(error);
        }

        function fetchAgendamentos() {
            const agendamentosRef = ref(db, COLLECTION_PATH);
            onValue(agendamentosRef, (snapshot) => {
                const data = snapshot.val() || {};
                const formatados = [];
                for (const dateKey in data) {
                    for (const hourKey in data[dateKey]) {
                        const item = data[dateKey][hourKey];
                        item.id = `${dateKey}/${hourKey}`;
                        item.data_hora = new Date(`${item.data}T${item.horario}:00`);
                        formatados.push(item);
                    }
                }
                formatados.sort((a, b) => a.data_hora - b.data_hora);
                agendamentos = formatados;
                render();
            });
        }

        window.salvarAgendamento = async (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = formData.get('data');
            const horario = formData.get('horario');
            
            const novoAgendamento = {
                data: data,
                horario: horario,
                nome_formando: formData.get('nome'),
                numero_foto: formData.get('foto'),
                endereco: formData.get('endereco')
            };

            try {
                // Salva no Firebase usando data e hora como chaves para evitar duplicidade
                const path = `${COLLECTION_PATH}/${data}/${horario.replace(':', '-')}`;
                await set(ref(db, path), novoAgendamento);
                alert("Agendamento realizado com sucesso!");
                event.target.reset();
            } catch (error) {
                alert("Erro ao agendar: " + error.message);
            }
        };

        function render() {
            const rowHtml = agendamentos.map(a => `
                <tr class="border-b text-xs">
                    <td class="p-2 font-bold">${a.data.split('-').reverse().join('/')} - ${a.horario}</td>
                    <td class="p-2">${a.nome_formando}</td>
                    <td class="p-2 text-blue-600 font-bold">${a.numero_foto}</td>
                </tr>`).join('');

            document.getElementById('app-content').innerHTML = `
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-blue-600">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Novo Agendamento</h2>
                        <form onsubmit="salvarAgendamento(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nome do Formando</label>
                                <input type="text" name="nome" required class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Data</label>
                                    <input type="date" name="data" required class="w-full p-2 border rounded-lg outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Horário</label>
                                    <input type="time" name="horario" required class="w-full p-2 border rounded-lg outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Número da Foto (ou Álbum)</label>
                                <input type="text" name="foto" required class="w-full p-2 border rounded-lg outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Endereço Completo</label>
                                <textarea name="endereco" required class="w-full p-2 border rounded-lg outline-none" rows="2"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-md">
                                Confirmar Agendamento
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-gray-400">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Horários Ocupados</h2>
                        <div class="overflow-y-auto max-h-[400px]">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr class="text-[10px] uppercase text-gray-500">
                                        <th class="p-2">Data/Hora</th>
                                        <th class="p-2">Formando</th>
                                        <th class="p-2">Foto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowHtml || '<tr><td colspan="3" class="p-4 text-center text-gray-400">Nenhum horário reservado.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        }
    </script>
</body>
</html>
